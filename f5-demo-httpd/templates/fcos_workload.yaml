variant: fcos
version: 1.4.0
passwd:
  users:
  - name: core
    ssh_authorized_keys:
    - ${ssh_public_key}
systemd:
  units:
  - name: frontend.service
    enabled: true
    contents: |
      [Unit]
      Description=nginx frontend
      After=network-online.target
      Wants=network-online.target
      [Service]
      ExecStartPre=-/bin/podman kill frontend
      ExecStartPre=-/bin/podman rm frontend
      ExecStartPre=/bin/podman pull docker.io/f5devcentral/f5-demo-httpd:nginx
      ExecStart=/bin/podman run --name frontend -p 80:80 -e F5DEMO_APP=frontend -e F5DEMO_BACKEND_URL=http://backend.corp:8080 -e F5DEMO_NODENAME="${cluster_name}" -v /etc/hosts.frontend:/etc/hosts:z f5devcentral/f5-demo-httpd:nginx
      [Install]
      WantedBy=multi-user.target
  - name: backend.service
    enabled: true
    contents: |
      [Unit]
      Description=nginx backend
      After=network-online.target
      Wants=network-online.target
      [Service]
      ExecStartPre=-/bin/podman kill backend
      ExecStartPre=-/bin/podman rm backend
      ExecStartPre=/bin/podman pull docker.io/f5devcentral/f5-demo-httpd:nginx
      ExecStart=/bin/podman run --name backend -p 8080:80 -e F5DEMO_APP=backend -e F5DEMO_NODENAME="${cluster_name}" -v /etc/hosts.frontend:/etc/hosts:z f5devcentral/f5-demo-httpd:nginx
      [Install]
      WantedBy=multi-user.target
storage:
  files:
  - path: /etc/hosts.frontend
    mode: 0644
    contents:
      inline: |
        127.0.0.1       localhost
        255.255.255.255 broadcasthost
        10.10.10.10     backend.corp frontend.corp
  - path: /usr/local/bin/shellwrk
    mode: 0755
    contents:
      inline: |
        sudo grep -v workload /etc/hosts > /tmp/hosts
        sudo echo "10.64.15.254 workload.remote" >> /tmp/hosts
        sudo echo "10.64.15.254 workload.local" >> /tmp/hosts
        sudo echo "10.64.15.254 workload.site1" >> /tmp/hosts
        sudo cp /tmp/hosts /etc/
        sudo docker run -ti --rm --name wrk --privileged --net host --pid host marcelwiget/wrk
